<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

<html ng-app="app" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Knowtify</title>

    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta charset="utf-8" />
    <meta name="description" content="knowtshare: collaborative modeling " />
    <meta name="author" content="Apprentice Systems" />


    <script src="Scripts/jquery-2.1.1.min.js"></script>
    <script src="/Scripts/moment.min.js"></script>
    <script src="Scripts/angular.js"></script>

    <link href="content/bootstrap.min.css" rel="stylesheet" />
    <link href="content/toastr.min.css" rel="stylesheet" />

    <!--    <script src="https://shapesignal.azure-mobile.net/client/MobileServices.Web-1.0.0.min.js"></script>-->
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="Scripts/jquery.signalR-2.0.0.min.js"></script>
    <script src="/signalr/hubs"></script>

    <script src="http://foundryjs.azurewebsites.net/Foundry/FoundryUI.min.js" type="text/javascript"></script>
    <script src="http://foundryjs.azurewebsites.net/Foundry/Foundry.rules.factory.js"></script>

</head>

<body ng-controller="geoController">
    <div>
        <button ng-click="openSessionClick()">start session</button>
        SessionKey: [ {{vm.sessionKey}} ]<br /><br />
        Latitude: [ {{Latitude}} ]<br />

        Longitude: [ {{Longitude}} ]<br />

        {{Errors}}



        <button ng-click="pingClick()" >send location</button>

        <p><a href="http://knowtshare.azurewebsites.net/Home/KnowtShare/{{sessionKey}}" target="_blank">launch knowtshare</a></p>
        <p><a href="Knowtify.html" target="_blank">launch knowtify</a></p>
        <p><a href="/Home/KnowtShare/{{sessionKey}}" target="_blank">knowtshare</a></p>

        <button ng-click="refreshClick()">refresh</button>
        <pre>{{modelSpec}}</pre>
    </div>
    <div id="content"></div>

</body>



<script src="App/ShapeShareViewModel.js"></script>
<script src="App/ShapeShareStencil.js"></script>
<script src="App/KnowtDialog.js"></script>
<script src="App/KnowtShareApp.js"></script>

<script>

    var app = angular.module('app', []);


    app.controller('geoController', function ($scope) {

        var shapeHub = $.connection.shapeHub;
        fo.utils.xmlHttpGet('Diagram.Templates.html', function (text, xhr) {
            var head = document.getElementsByTagName("head")[0];
            var script = document.createElement('div');

            script.innerHTML = text;
            head.appendChild(script);
        });

        var ctrl = KnowtShareApp(Foundry, shapeHub, Handlebars, toastr);

        function showPosition(position) {
            $scope.Latitude = position.coords.latitude;
            $scope.Longitude = position.coords.longitude;
            $scope.$apply();

            //now send a note...


            //ctrl.pasteTextToNote = function (text) {
            //    var note = ctrl.createNote(text).note;
            //    fo.publish('ModelChanged', [note]);
            //}

            var geo = { timestamp: position.timestamp };
            for (var key in position.coords) {
                if (position.coords[key]) {
                    geo[key] = position.coords[key];
                }
            }

            //var comp = fo.makeComponent({});
            //comp.redefine('geo', geo);
            //var sp = comp.getSpec();


            var header = moment().format('MMMM Do YYYY, h:mm:ss a');
            var text = "Lat:{0} Lng:{1}".format(geo.latitude, geo.longitude);
            var note = ctrl.createKnowtification(geo, header, text);
            note.establishManagedProperty('geo', geo);

            var spec = note.getSpec();
            toastr.success(text);

        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            }
            else {
                $scope.Errors = "Geolocation is not supported by this browser.";
            }
        }

        $scope.openSessionClick = function () {
            ctrl.doJoinSession;
            $scope.$Apply();
        }

        $scope.pingClick = function () {
            getLocation();

            //var text = 'pingClick';
            //var note = ctrl.createKnowtification(undefined, text);
            toastr.info('sent');
        }

        $scope.refreshClick = function () {
            var target = ctrl.currentModelTarget();
            var payload = workspace.currentModelToPayload();
            var spec = JSON.parse(payload);
            $scope.modelSpec = JSON.stringify(spec, undefined, 3);
        }


        //http://codeseven.github.io/toastr/demo.html
        toastr.options = {
            positionClass: "toast-bottom-right",
        }


        var args = fo.utils.queryStringToObject(window.location.toString(), '?');
        var sessionKey = args && args.session;

        $scope.modelSpec = '';
        $scope.vm = ctrl;


        $.connection.hub.start().done(function () {
            ctrl.start(sessionKey);
        });

    })



</script>
</html>






