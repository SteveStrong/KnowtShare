<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

<html ng-app="app" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Knowtify</title>

    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta charset="utf-8" />
    <meta name="description" content="knowtshare: collaborative modeling " />
    <meta name="author" content="Apprentice Systems" />


    <script src="Scripts/jquery-2.1.1.min.js"></script>
    <script src="/Scripts/moment.min.js"></script>
    <script src="Scripts/angular.js"></script>

    <link href="content/bootstrap.min.css" rel="stylesheet" />
    <link href="content/toastr.min.css" rel="stylesheet" />

    <!--    <script src="https://shapesignal.azure-mobile.net/client/MobileServices.Web-1.0.0.min.js"></script>-->
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="Scripts/jquery.signalR-2.0.0.min.js"></script>
    <script src="/signalr/hubs"></script>

    <script src="http://foundryjs.azurewebsites.net/Foundry/FoundryUI.min.js" type="text/javascript"></script>
    <script src="http://foundryjs.azurewebsites.net/Foundry/Foundry.rules.factory.js"></script>

</head>

<body ng-controller="geoController">
    <div>
        <button ng-click="openSessionClick()">start session</button>
        SessionKey: [ {{vm.sessionKey}} ]<br /><br />
        Latitude: [ {{Latitude}} ]<br />

        Longitude: [ {{Longitude}} ]<br />

        {{Errors}}



        <button ng-click="pingClick()" >send location</button>

        <p><a href="http://knowtshare.azurewebsites.net/Home/KnowtShare/{{sessionKey}}" target="_blank">launch knowtshare</a></p>
        <p><a href="Knowtify.html" target="_blank">launch knowtify</a></p>
        <p><a href="/Home/KnowtShare/{{sessionKey}}" target="_blank">knowtshare</a></p>

        <button ng-click="refreshClick()">refresh</button>
        <pre>{{modelSpec}}</pre>
    </div>
    <div id="content"></div>

</body>

<script id="dialogTemplate" type="text/x-handlebars-template">
    <div class="modal fade" id="{{myID}}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" data-bind="click: doClose" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    {{{headerHTML}}}
                </div>
                <div class="modal-body">
                    {{{bodyHTML}}}
                </div>
                <div class="modal-footer">
                    <button id="IDShowDetailsDialogButton" class="btn btn-default pull-left" data-toggle="collapse" data-target="#IDShowDetails" data-bind="click: doShowDetailsToggle">More...</button>
                    <button id="IDOkDialogButton" class='btn btn-success' data-dismiss='modal' data-bind='click: doOK'>OK</button>
                    <button id="IDCancelDialogButton" class='btn' data-dismiss='modal' data-bind='click: doCancel'>Cancel</button>
                </div>
            </div>
        </div>
    </div>
</script>

<script id="noteHeaderTemplate" type="text/html">
    <p>by {{author}}</p>
</script>

<!--     data-bind="show: hasNoteUri"  class="btn btn-default glyphicon glyphicon-link"-->

<script id="noteBodyTemplate" type="text/html">
    <div data-context="context">
        <div class="form-horizontal" role="form">
            <div class="form-group notePanel-formGroup" style="margin-left:2px">
                <label for="IDTextSummary" class="control-label">Headline:</label>
                <input class="form-control" style="display:inline" id="IDTextSummary" data-bind="value: headerText" data-update="keyup" placeholder="the note summary" />
            </div>
            <div id="IDShowDetails" class="panel-collapse collapse">
                <div class="form-group notePanel-formGroup" style="margin-left:2px">
                    <label for="IDTextNote" class="control-label">Details:</label>
                    <textarea class="form-control" id="IDTextNote" rows="5" data-bind="value: noteText" data-update="keyup" placeholder="the note text"></textarea>
                </div>
                <div class="form-group notePanel-formGroup" style="margin-left:2px">
                    <label for="IDTextURI" class="control-label"> <a href="#" target="_blank" data-bind="enabled: hasNoteUri, href: noteUri">Link: </a>(ex. http://www.knowtshare.com)</label>
                    <input class="form-control" id="IDTextURI" data-bind="value: noteUri" data-update="keyup" placeholder="the note uri" />
                </div>
            </div>

        </div>
    </div>
</script>

<script id="sessionShareHeaderTemplate" type="text/html">
    <p>Share this link with a friend.</p>
</script>

<script id="sessionShareBodyTemplate" type="text/html">
    <div data-context="context">
        <div class="form-horizontal" role="form">
            <div class="form-group">
                <label for="IDSessionLink" class="control-label">Text:</label>
                <textarea id="IDSessionLink" class="form-control" rows="5" data-bind="value: knowtifySessionUrl"></textarea>
            </div>

            <div class="form-group">
                <a class="btn btn-link" href="http://www.knowtshare.com" target="_blank" data-bind="href: knowtifySessionUrl">Open in new window.</a>
                <a id="tweetShare" href="https://twitter.com/share" class="twitter-share-button" data-bind="data_url: knowtifySessionUrl" data-url="http://www.knowtshare.com" data-text="" data-via="KnowtShare" data-size="large" data-hashtags=""></a>
            </div>
        </div>
    </div>
</script>

<script id="sessionJoinHeaderTemplate" type="text/html">
    <p>Enter the Session that you want to join.</p>
</script>

<script id="sessionJoinTemplate" type="text/html">
    <div data-context="context">
        <div class="form-horizontal" role="form">
            <h4>Other collaborators can join you by entering this session.</h4>
            <div class="form-group">
                <label for="IDSessionKey" class="control-label"></label>
                <input autofocus id="IDSessionKey" class="form-control" type="text" data-bind="value: sessionKey" data-update="keyup" placeholder="type a shareable Session word or phrase" />
                <!--                <button class="btn btn-primary col-md-1" data-bind="click: doGenerateSessionKey" ></button>-->
            </div>
        </div>
    </div>
</script>

<script id="sessionCreateHeaderTemplate" type="text/html">
    <p>Enter the session that you want to create.</p>
</script>

<script id="sessionCreateTemplate" type="text/html">
    <div data-context="context">
        <div class="form-horizontal" role="form">
            <h4>Other collaborators can join you by entering this session.</h4>
            <div class="form-group">
                <label for="IDSessionKey" class="control-label"></label>
                <input autofocus id="Text1" class="form-control" type="text" data-bind="value: sessionKey" data-update="keyup" placeholder="type a shareable Session word or phrase" />
                <!--                <button class="btn btn-primary col-md-1" data-bind="click: doGenerateSessionKey" ></button>-->
            </div>

            <!--                <div class="radio">
                              <label>
                                <input type="radio" data-bind="value: collaborator" />
                                <b>Open Collaberation</b>&nbsp;&mdash;&nbsp;<em>freely share notes and take contributions from other subscribers</em>
                              </label>
                             </div>-->
            <div class="checkbox">
                <label>
                    <input type="checkbox" data-bind="value: presenter" />
                    <b>Presenter:Audience</b>&nbsp;&mdash;&nbsp;<em>subscribers can only view your presentation</em>
                </label>
            </div>
            <!--                 <div class="radio">
                              <label>
                                <input type="radio" name="optionsRadios" id="Radio3" />
                                  <b>Master:Apprentice</b>&nbsp;&mdash;&nbsp;<em>subscribers can modify their presentation with personal notes</em>
                              </label>
                            </div>-->
        </div>
    </div>
</script>

<script id="openFileHeaderTemplate" type="text/html">
    <p>Select a file to open.</p>
</script>

<script id="openFileTemplate" type="text/html">
    <div data-context="context">
        <div role="form">
            <div class="form-group">
                <label for="IDOpenFile">File :</label>
                <input id="IDOpenFile" type="file" name="files[]">
                <!--                <p class="help-block">Load notes from local file system</p>-->
            </div>
        </div>
    </div>
</script>

<script id="saveFileHeaderTemplate" type="text/html">
    <p>Type in a filename.</p>
</script>

<script id="saveFileTemplate" type="text/html">
    <div data-context="context">
        <div role="form">
            <div class="form-group">
                <label for="IDSaveFile">File :</label>
                <input id="IDSaveFile" type="text" data-bind="value: documentName" data-update="keyup" placeholder="type in the file name">
                <!--                <p class="help-block">Save notes from local file system</p>-->
            </div>
        </div>
    </div>
</script>

<script id="invitationTemplate" type="text/html">
    <div data-context="target">
        <p>Cut and paste this URL and send it to a friend.</p>
        <textarea rows="5" cols="50" data-bind="value: invitationUrl"></textarea>
    </div>
</script>

<script id="nickNameTemplate" type="text/html">
    <div>
        <p>Create or change your nick name:</p>
        <input type="text" data-bind="value: nickName" data-update="keyup" placeholder="ie: James Bond">
    </div>
</script>

<script id="messageBox" type="text/html">
    <div data-height="200" data-width="400" data-caption="Message">
        <p data-bind="text: message"></p>
    </div>
</script>

<script id="contentMessageBox" type="text/html">
    <div data-height="200" data-width="400" data-caption="Message">
        <div data-bind="html: content"></div>
    </div>
</script>

<script src="App/ShapeShareViewModel.js"></script>
<script src="App/ShapeShareStencil.js"></script>
<script src="App/KnowtDialog.js"></script>
<script src="App/KnowtShareApp.js"></script>

<script>

    var app = angular.module('app', []);


    app.controller('geoController', function ($scope) {

        var shapeHub = $.connection.shapeHub;
        fo.utils.xmlHttpGet('Diagram.Templates.html', function (text, xhr) {
            var head = document.getElementsByTagName("head")[0];
            var script = document.createElement('div');

            script.innerHTML = text;
            head.appendChild(script);
        });

        var ctrl = KnowtShareApp(Foundry, shapeHub, Handlebars, toastr);

        function showPosition(position) {
            $scope.Latitude = position.coords.latitude;
            $scope.Longitude = position.coords.longitude;
            $scope.$apply();

            //now send a note...


            //ctrl.pasteTextToNote = function (text) {
            //    var note = ctrl.createNote(text).note;
            //    fo.publish('ModelChanged', [note]);
            //}

            var geo = { timestamp: position.timestamp };
            for (var key in position.coords) {
                if (position.coords[key]) {
                    geo[key] = position.coords[key];
                }
            }

            //var comp = fo.makeComponent({});
            //comp.redefine('geo', geo);
            //var sp = comp.getSpec();


            var header = moment().format('MMMM Do YYYY, h:mm:ss a');
            var text = "Lat:{0} Lng:{1}".format(geo.latitude, geo.longitude);
            var note = ctrl.createKnowtification(geo, header, text);
            note.establishManagedProperty('geo', geo);

            var spec = note.getSpec();
            toastr.success(text);

        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            }
            else {
                $scope.Errors = "Geolocation is not supported by this browser.";
            }
        }

        $scope.openSessionClick = function () {
            ctrl.doJoinSession;
            $scope.$Apply();
        }

        $scope.pingClick = function () {
            getLocation();

            //var text = 'pingClick';
            //var note = ctrl.createKnowtification(undefined, text);
            toastr.info('sent');
        }

        $scope.refreshClick = function () {
            var target = ctrl.currentModelTarget();
            var payload = workspace.currentModelToPayload();
            var spec = JSON.parse(payload);
            $scope.modelSpec = JSON.stringify(spec, undefined, 3);
        }


        //http://codeseven.github.io/toastr/demo.html
        toastr.options = {
            positionClass: "toast-bottom-right",
        }


        var args = fo.utils.queryStringToObject(window.location.toString(), '?');
        var sessionKey = args && args.session;

        $scope.modelSpec = '';
        $scope.vm = ctrl;


        $.connection.hub.start().done(function () {
            ctrl.start(sessionKey);
        });

    })



</script>
</html>






